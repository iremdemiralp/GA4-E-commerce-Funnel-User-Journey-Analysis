WITH sessions_info AS (
  SELECT
    PARSE_DATE('%Y%m%d',event_date ) AS event_date,
    CAST(user_pseudo_id AS string) AS user_pseudo_id,
    (SELECT ep.value.int_value FROM UNNEST(event_params) AS ep WHERE ep.key = 'ga_session_id') AS session_id,
    CONCAT(user_pseudo_id, '-', CAST((SELECT ep.value.int_value FROM UNNEST(event_params) AS ep WHERE ep.key = 'ga_session_id') AS STRING)) AS user_session_id,
    regexp_extract((SELECT ep.value.string_value FROM UNNEST(event_params) AS ep WHERE ep.key = 'page_location'), r'(?:https:\/\/)?[^\/]+\/(.*)') as landing_page_location,
    geo.country,
    device.category AS device_category,
    device.language AS device_language,
    device.operating_system,
    traffic_source.source,
    traffic_source.medium,
    traffic_source.name AS campaign
  FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
  WHERE event_name = 'session_start'  -- SADECE SESSION START!
),

events AS (
  SELECT
    TIMESTAMP_MICROS(event_timestamp) AS event_timestamp,
    event_name,
    CONCAT(user_pseudo_id, '-', CAST((SELECT ep.value.int_value FROM UNNEST(event_params) AS ep WHERE ep.key = 'ga_session_id') AS STRING)) AS user_session_id
  FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
  WHERE event_name IN ('session_start', 'view_item', 'add_to_cart', 'begin_checkout', 'add_shipping_info', 'add_payment_info', 'purchase')
)

SELECT 
  s.*, 
  e.event_timestamp,
  e.event_name
FROM sessions_info s
LEFT JOIN events e USING(user_session_id);
